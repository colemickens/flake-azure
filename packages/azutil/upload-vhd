#!/usr/bin/env bash
set -euo pipefail
set -x

function az() { time command __AZ__ "${@}"; }
BLOBXFER="__BLOBXFER__"

builddir="${1}"
image_vhd="$(readlink -f ${builddir}/disk.vhd.zstd)"

if ! az group show -n "${AZURE_IMAGE_GROUP}" &>/dev/null; then
  az group create --name "${AZURE_IMAGE_GROUP}" --location "${AZURE_LOCATION}"  &>/dev/stderr
fi

if ! az storage account show --name "${AZURE_IMAGE_GROUP}" &>/dev/null; then
  az storage account create -n "${AZURE_IMAGE_GROUP}" -g "${AZURE_IMAGE_GROUP}" -l "westus2" --sku "Standard_LRS"  &>/dev/stderr
fi

if ! az storage container show --account-name "${AZURE_IMAGE_GROUP}" --name "vhd" &>/dev/null; then
  az storage container create --verbose --account-name "${AZURE_IMAGE_GROUP}" --name "vhd" &>/dev/stderr
fi

if ! az storage blob show --account-name "${AZURE_IMAGE_GROUP}" --container-name "vhd" --name "${AZURE_IMAGE_NAME}" &>/dev/null; then
  sasurl="$(az storage blob generate-sas \
    --permissions acdrw \
    --expiry "$(date -u -d "1 hour" '+%Y-%m-%dT%H:%MZ')" \
    --account-name "${AZURE_IMAGE_GROUP}" \
    --container-name "vhd" \
    --name "${AZURE_IMAGE_NAME}"\
    --full-uri -o tsv)"

  zstdcat "${image_vhd}" \
    | time "${BLOBXFER}" upload \
      --storage-url "${sasurl}" \
      --local-path -
fi

# get blob url
bloburl="$(az storage blob url \
  --account-name "${AZURE_IMAGE_GROUP}" \
  --container-name "vhd" \
  --name "${AZURE_IMAGE_NAME}" \
  -o tsv)"

# wait until we've succesfully created the image
if ! az image show -g "${AZURE_IMAGE_GROUP}" -n "${AZURE_IMAGE_NAME}" &>/dev/null; then
  until az image create \
    --resource-group "${AZURE_IMAGE_GROUP}" \
    --name "${AZURE_IMAGE_NAME}" \
    --source "${bloburl}" \
    --hyper-v-generation "V2" \
    --os-type "linux" >/dev/null;
  do
    sleep 1
  done
fi

# now dump the image id to standard out
az image show --resource-group "${AZURE_IMAGE_GROUP}" \
  --name "${AZURE_IMAGE_NAME}" \
  -o tsv \
  --query "[id]"
