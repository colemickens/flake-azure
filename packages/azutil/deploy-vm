#!/usr/bin/env bash
set -x
set -euo pipefail

function az() { time command __AZ__ "${@}"; }

# upload the VHD
if ! az image show -g "${AZURE_IMAGE_GROUP}" -n "${AZURE_IMAGE_NAME}" &>/dev/null; then
  # build the VHD
  nix build "${AZURE_DISK_ATTR}" --out-link /tmp/${AZURE_MACHINE_NAME}

  # upload, capture image_id
  image_id="$(upload-vhd /tmp/${AZURE_MACHINE_NAME})"
fi

image_id="$(az image show -g "${AZURE_IMAGE_GROUP}" -n "${AZURE_IMAGE_NAME}" -o tsv --query '[id]')"

az group create -n "${MACHINE_GROUP}" -l "${AZURE_LOCATION}"
args=(
  --name "${MACHINE_NAME}"
  --resource-group "${MACHINE_GROUP}"
  --size "${AZURE_VM_SIZE}"
  --image "${image_id}"
  --attach-data-disks "${DATA_DISK_ID}"
  --admin-username "azureuser"
  --location "${AZURE_LOCATION}"
  --ssh-key-values "${AZURE_SSH}"
  --public-ip-address-dns-name "${MACHINE_NAME}"
)

[[ "${AZURE_PUBLIC_IP:-""}" != "" ]]       && args=("${args[@]}" "--public-ip-address" "${AZURE_PUBLIC_IP}")
[[ "${AZURE_NSG:-""}" != "" ]]             && args=("${args[@]}" "--nsg" "${AZURE_NSG}")
[[ "${AZURE_ACCEL_NIC:-""}" == "true" ]]   && args=("${args[@]}" "--accelerated-networking")

[[ "${AZURE_STORAGE_SKU:-""}" != "" ]]        && args=("${args[@]}" "--storage-sku" "${AZURE_STORAGE_SKU}")
[[ "${AZURE_VM_OS_DISK_SIZE:-""}" != "" ]]    && args=("${args[@]}" "--os-disk-size-gb" "${AZURE_VM_OS_DISK_SIZE}")
[[ "${AZURE_EPHEMERAL_DISK:-""}" == "true" ]] && args=("${args[@]}" "--ephemeral-os-disk")

az vm create "${args[@]}"
